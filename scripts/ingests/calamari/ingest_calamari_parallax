import sys
import logging
sys.path.append(".")
from astropy.io import ascii
from simple import REFERENCE_TABLES
from astrodb_utils import load_astrodb
from astrodb_utils.sources import (
    logger,
    AstroDBError,
    find_source_in_db
)
from astrodb_utils.publications import (
    find_publication,
)
from simple.utils.astrometry import (
    ingest_parallax
)

astrodb_utils_logger = logging.getLogger("astrodb_utils")
logger.setLevel(logging.DEBUG)  # Set logger to INFO/DEBUG/WARNING/ERROR/CRITICAL level
astrodb_utils_logger.setLevel(logging.DEBUG)

SAVE_DB = False  # save the data files in addition to modifying the .db file
RECREATE_DB = True  # recreates the .db file from the data files
SCHEMA_PATH = "simple/schema.yaml"
db = load_astrodb(
    "SIMPLE.sqlite",
    recreatedb=RECREATE_DB,
    reference_tables=REFERENCE_TABLES,
    felis_schema=SCHEMA_PATH,
)

link = (
    "scripts/ingests/calamari/calamari_data.csv"
)
link_2 = (
    "scripts/ingests/calamari/calamari_refs.csv"
)

calamari_table = ascii.read(
    link,
    format="csv",
    data_start=1,
    header_start=0,
    guess=False,
    fast_reader=False, 
    delimiter=",",
)

ref_table = ascii.read(
    link_2,
    format="csv",
    data_start=0,
    header_start=0,
    guess=False,
    fast_reader=False, 
    delimiter=",",
)

parallax_ingested = 0
parallax_already_exist = 0
skipped= 0

binaries = [
    "HD 130948BC",
    "HD 130948C",
    "HD 130948B",
    "Gl 337CD",
    "Gl 337C",
    "Gl 337D",
    "Gl 417BC",
    "Gl 417B",
    "Gl 417C"
]

#helper method to retrieve the publication links from calamari_data
def getRef(ref_index):
    ref = ref_index.split(',')[0]
    ref_link = ref_table[int(ref)]['ADS']
    if 'iopscience' not in ref_link or 'harvard.edu' not in ref_link:
        ref_link = ref_table[int(ref)]['Link']
    return ref_link

#helper method to retrieve the bibcode from a link
def extractADS(link):
    start = link.find('abs/')+4
    end = link.find('/abstract')
    ads = link[start:end]
    ads = ads.replace("%26", "&")
    return ads

#helper method to retrieve the doi from a link
def extractDOI(link):
    link = str(link)
    if 'iopscience' in link:
        start = link.find('article/')+8
        doi = link[start:]
        doi = doi.replace("/pdf", "")
    else:
        start = link.find('doi.org/')+8
        doi=link[start:]
    return doi

def otherReferencesList(ref):
    #get all the ids/indexes of the references
    ids = ref.split(", ")
    result = []
    #for each reference...
    for id in ids:
        link = ref_table[int(id)]['ADS']
        #if bibcode or doi is not directly in the link... go to Link column
        if 'iopscience' not in link or 'harvard.edu' not in link:
            link = ref_table[int(id)]['Link']
        #if bibcode is directly in the link
        if 'harvard.edu' in link:
            bibcode = extractADS(link)
            pub_result=find_publication(
                db=db,
                bibcode=bibcode
            )
            if pub_result[0]:
                result.append(pub_result[1])
            else:
                print(f"Warning: Publication not found for bibcode {bibcode}")
            #if doi code is found directly in the link
        elif 'iopscience' in link or 'doi.org' in link:
            doi=extractDOI(link)
            pub_result=find_publication(
                db=db,
                doi=doi
            )
            if pub_result[0]:
                result.append(pub_result[1])
            else:
                print(f"Warning: Publication not found for doi {doi}")
        #use reference name to find reference
        else:
            reference= ref_table[int(id)]['Ref']
            reference= reference.replace("+", "")
            reference=reference[0:4] + reference[-2:]
            pub_result=find_publication(
                db=db,
                reference=reference
            )
            if pub_result[0]:
                result.append(pub_result[1])
            else:
                print(f"Warning: Publication not found for reference {reference}")
    #return list of references
    return result

#helper method to check if parallax exists
#returns a boolean
def parallaxExists(source, reference):
    exists = False
    parallax_search = db.search_object(
        name = source,
        output_table="Parallaxes"
    )
    if len(parallax_search) > 0:
        for parallax in parallax_search:
            if parallax["reference"] == reference:
                exists = True
                break
    
    return exists

for row in calamari_table:
    ignore_neighbors=False
    object = row["Object"]

    #skip these two sources because they have no parallax value or have been ingested beforehand
    if object == "HIP 21152 B" or object == "HD 72946 B":
        skipped+=1
        continue

    if object == "WISE J124332.17+600126.6":
        #ingest parallax for WISE J124332.17+600126.6
        ingest_parallax(
            db=db,
            source = "WISE J124332.17+600126.6",
            parallax_mas=22.24367115,
            parallax_err_mas=0.013506583,
            reference = "Fahe21"
        )
        parallax_ingested+=1
        continue
    
    if object == "2MASS J00250365+4759191":
        #ingest parallax for 2MASS J00250365+4759191
        ingest_parallax(
            db=db, 
            source = "2MASS J00250365+4759191",
            parallax_mas=18.5162,
            parallax_err_mas=0.1365,
            reference="Reid06.891"
        )
        parallax_ingested+=1
        continue

    reference = otherReferencesList(row["Ref"])[0]
    parallax_mas=row["Parallax (mas)"]

    if object in binaries:
        ignore_neighbors = True

    if not ignore_neighbors:
        object = find_source_in_db(db=db, source = object)[0]
    parallax_exists = parallaxExists(source = object, reference=reference)
    if not parallax_exists:
        try:
            ingest_parallax(
                db=db,
                source = object,
                parallax_mas=parallax_mas,
                parallax_err_mas=row["ePlx"],
                reference = reference
            )
            parallax_ingested+=1
        except AstroDBError as e:
            msg = "ingest failed with error: " + str(e)
            logger.warning(msg)
            if "Parallax already in the database" in str(e):
                parallax_already_exist+=1
            else:
                raise e
    else:
        parallax_already_exist+=1

        
logger.info(f"parallax already exists: {parallax_already_exist}") # 10 already exists in database
logger.info(f"parallax ingested: {parallax_ingested}") #52 parallax ingested
logger.info(f"parallax skipped: {skipped}") # 2 parallax skipped
logger.info(f"total: {parallax_already_exist+parallax_ingested+skipped}")  # 64 total
if SAVE_DB:
    db.save_database(directory="data/")